<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<dom-module id="my-firebase">
  <template>

    <paper-toast id="toast" text=""></paper-toast>

    <firebase-app
      auth-domain="petele-at-home.firebaseapp.com"
      database-url="https://petele-at-home.firebaseio.com/"
      api-key="AIzaSyCimAEx3GDDYlcQNnmQ2R9tu0CIEg8JVTA"
      storage-bucket="petele-at-home.appspot.com"
      messaging-sender-id="999286632442">
    </firebase-app>

    <firebase-auth id="fbAuth">
    </firebase-auth>

    <firebase-document
      path=".info/connected"
      data="{{fbIsConnected}}">
    </firebase-document>

    <firebase-document id="sendCommand" path="commands">
    </firebase-document>

    <firebase-document 
      path="devices/HomeOnNode/heartbeat"
      data="{{honHeartbeat}}">
    </firebase-document>

  </template>
  <script src="/scripts/keys.js"></script>
  <script>
    class MyFirebase extends Polymer.Element {
      static get is() { return 'my-firebase'; }

      static get observers() {
        return [
          'onlineChanged(fbIsConnected)',
          'serverTick(honHeartbeat)',
        ];
      }

      ready() {
        super.ready();
        this.initFirebase();
        window.app = window.app || {};
        window.app.sendCommand = (cmd) => {
          window.app.lastInput = Date.now();
          if (this.$.fbAuth.signedIn === false) {
            this.showToast('Not logged in.');
            this.initFirebase(cmd);
            return;
          }
          let ref = this.$.sendCommand.ref.push(cmd, (err) => {
            if (err) {
              this.showToast(err.message);
            }
          });
          console.log('[sendCommand]', ref.key, cmd);
        };
      }

      initFirebase(cmd) {
        let fbUser = window.fbUser;
        let fbPassword = window.fbPassword;
        this.$.fbAuth.signInWithEmailAndPassword(fbUser, fbPassword)
          .then(() => {
            if (cmd) {
              app.sendCommand(cmd);
            }
          })
          .catch(this.onFirebaseAuthFail);
      }

      showToast(message) {
        this.$.toast.text = message;
        this.$.toast.show();
      }

      onFirebaseAuthFail(err) {
        console.log('onFirebaseAuthFail', err);
        this.showToast(err.message);
      }

      onlineChanged(newVal) {
        if (newVal === true) {
          this.showToast('Connected.');
        } else {
          this.showToast('Disconnected.');
        }
      }

      serverTick(newVal) {
        if (newVal) {
          this.serverTickedAt = newVal;
        }
      }

    }

    window.customElements.define(MyFirebase.is, MyFirebase);
  </script>
</dom-module>
