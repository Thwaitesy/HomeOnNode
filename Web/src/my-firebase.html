<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<dom-module id="my-firebase">
  <template>

    <paper-toast id="toast"></paper-toast>

    <firebase-app
      auth-domain="petele-at-home.firebaseapp.com"
      database-url="https://petele-at-home.firebaseio.com/"
      api-key="{{fbApiKey}}"
      storage-bucket="petele-at-home.appspot.com"
      messaging-sender-id="999286632442">
    </firebase-app>

    <firebase-auth id="fbAuth">
    </firebase-auth>

    <firebase-document
      path=".info/connected"
      data="{{fbIsConnected}}">
    </firebase-document>

    <firebase-document 
      path="devices/HomeOnNode/heartbeat"
      data="{{honHeartbeat}}">
    </firebase-document>

  </template>
  <script src="/scripts/keys.js"></script>
  <script>
    class MyFirebase extends Polymer.Element {
      static get is() { return 'my-firebase'; }

      static get observers() {
        return [
          'onlineChanged(fbIsConnected)',
          'serverTick(honHeartbeat)',
        ];
      }

      ready() {
        super.ready();
        this.initFirebase();
      }

      initFirebase() {
        let user = window.honKeys.user;
        let password = window.honKeys.password;
        this.fbApiKey = window.honKeys.apiKey;
        this.$.fbAuth.signInWithEmailAndPassword(user, password)
          .catch((err) => {
            // eslint-disable-next-line no-console
            console.log('onFirebaseAuthFail', err);
            this.showToast(err.message);
          });
      }

      showToast(message) {
        this.$.toast.text = message;
        this.$.toast.show();
      }

      onlineChanged(newVal) {
        // eslint-disable-next-line no-console
        console.log('Firebase Connected:', newVal);
        if (newVal === true) {
          this.showToast('Connected.');
        } else {
          this.showToast('Disconnected.');
        }
      }

      serverTick(newVal) {
        if (newVal) {
          this.serverTickedAt = newVal;
        }
      }

    }

    window.customElements.define(MyFirebase.is, MyFirebase);
  </script>
</dom-module>
