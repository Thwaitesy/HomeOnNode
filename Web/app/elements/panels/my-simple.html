<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="my-simple">
  <template>
    <style include="shared-styles"></style>
    <style>
      paper-material {
        background-color: white;
      }

      @media (max-width: 600px) {
        paper-material {
          padding: 16px 16px 0 16px;
        }
      }

      /* Tablet+ */
      @media (min-width: 601px) {
        paper-material {
          padding: 16px 32px 16px 32px;
          margin: 32px;
        }
      }

      my-scenes /deep/ paper-material {
        margin-top: 1em;
      }
      
      @media screen and (orientation: landscape) {
        my-scenes {
          display: none;
        }
      }

      my-clock /deep/ h2 {
        font-size: 4em;
        margin-bottom: 0;
      }

      home-state {
        margin-top: 0;
      }

      home-state /deep/ action-button {
        height: inherit;
        width: 50%;
      }

      action-button {
        margin-bottom: 12px;
      }

      info-bubble {
        margin-bottom: 12px;
      }
      paper-dialog {
        background-color: white;
      }
      paper-dialog div {
        margin-top: 0;
      }
      .secondary {
        color: var(--secondary-text-color);
      }

      .forecast-dialog {
        min-width: 300px;
      }

      .current-temp {
        @apply(--paper-font-display1);
        margin-right: 12px;
      }

      .weatherIcon {
        --iron-icon-width: 96px;
        --iron-icon-height: 96px;
      }

      .feels-like:before {
        content: "Feels like: ";
        color: #888;
      }

      .temp-high:before {
        content: "High: ";
        color: #888;
      }

      .temp-low:before {
        content: "Low: ";
        color: #888;
      }

      .precip:before {
        content: "Precipitation: ";
        color: #888;
      }

      .humidity:before {
        content: "Humidity: ";
        color: #888;
      }

      .pollen:before {
        content: "Pollen Count: ";
        color: #888;
      }

      .pcount:before {
        content: "Pollen ";
        color: #888;
      }

    </style>

    <paper-material>
      <div hidden>
        <iron-icon icon="weather-icons:clear"></iron-icon>
      </div>
      <div class="layout horizontal around-justified">
        <my-clock></my-clock>
      </div>
      <div class="layout horizontal justified wrap">
        <info-bubble id="ibDnD" label="Alerts" loading 
          icon="[[state.dndIcon]]" on-tap="toggleDnD"></info-bubble>
        <info-bubble id="ibNest" label="Nest" loading 
          icon="[[state.nestCamIcon]]" on-tap="toggleNest"></info-bubble>
        <info-bubble id="ibState" label="[[state.state]]" loading
          icon="[[state.stateIcon]]" on-tap="toggleState"></info-bubble>
        <info-bubble id="ibInside" label="Inside" loading
          value="[[state.temperature.inside]]" on-tap="tapHVAC">
        </info-bubble>
        <info-bubble id="ibWeather" label="Today" loading
          value="[[state.temperature.outside]]" on-tap="showWeather">
        </info-bubble>
      </div>

      <div class="layout vertical">
        <div class="layout horizontal">
          <action-button class="flex" on-tap="tapMorning" no-toggle="true">
            Morning
          </action-button>
          <action-button class="flex" on-tap="tapAwake" no-toggle="true">
            Awake
          </action-button>
          <action-button class="flex" on-tap="tapSleep" no-toggle="true">
            Sleep
          </action-button>  
        </div>
        <template is="dom-repeat" items="[[buttons]]" sort="sortButtons">
          <action-button on-tap="tapButton" no-toggle="true">[[item.label]]</action-button>
        </template>
      </div>

      <paper-dialog id="weatherDialog" class="forecast-dialog" modal>
        <h2>New York, NY</h2>
        <div class="description">[[weather.now.summary]]</div>
        <div class="layout horizontal flex">
          <div class="layout horizontal flex">
            <iron-icon class="weatherIcon" src="[[weather.now.icon]]"></iron-icon> 
            <div class="current-temp">
              <span class="value">[[weather.now.temperature]]</span><span class="scale">&deg;F</span>
            </div>
          </div>
          <div class="layout vertical flex">
            <div class="feels-like">
              <span class="value">[[weather.now.feel]]</span><span class="scale">&deg;F</span>
            </div>
            <div class="temp-high">
              <span class="value">[[weather.today.high]]</span><span class="scale">&deg;F</span>
            </div>
            <div class="temp-low">
              <span class="value">[[weather.today.low]]</span><span class="scale">&deg;F</span>
            </div>
            <div class="precip">[[weather.today.precip]]</div>
            <div class="humidity">[[weather.today.humidity]]</div>
            <div class="pollen" hidden>[[weather.today.pollen]]</div>
          </div>
        </div>
        <div class="buttons">
          <paper-button dialog-dismiss>Close</paper-button>
        </div>
      </paper-dialog>
    </paper-material>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'my-simple',
        ready: function() {
          this.state = {
            state: 'State',
            stateIcon: null,
            doNotDisturb: 'false',
            dndIcon: null,
            nestCam: '',
            nestIcon: null,
            temperature: {
              inside: '',
              outside: ''
            }
          };
          this.buttons = [];
          this.setup();
        },
        setup: function() {
          var self = this;
          var fbRoot = app.fbRoot;
          var keyPath = 'config/WebUI/default/homeCommands';
          fbRoot.child(keyPath).on('value', 
            function(snapshot) {
              var keys = snapshot.val();
              self.buttons = keys;
            }
          );
          fbRoot.child('state/systemState').on('value', function(snapshot) {
            var val = snapshot.val();
            self.set('state.state', val);
            var icon = 'error';
            var color = '--paper-red-500';
            if (val === 'AWAY') {
              icon = 'my-icons:state-away';
              color = null;
            } else if (val === 'HOME') {
              icon = 'my-icons:state-home';
              color = null;
            } else if (val === 'ARMED') {
              icon = 'my-icons:state-armed';
              color = '--paper-red-500';
            }
            self.set('state.stateIcon', icon);
            self.$.ibState.toggleAttribute('loading', false);
            self.$.ibState.setAttribute('color', color);
          });
          fbRoot.child('state/doNotDisturb').on('value', function(snapshot) {
            var val = snapshot.val();
            var icon = 'social:notifications-active';
            var color = null;
            if (val === true) {
              icon = 'social:notifications-off';
              color = '--paper-red-500';
            }
            self.set('state.doNotDisturb', val);
            self.set('state.dndIcon', icon);
            self.$.ibDnD.setAttribute('color', color);
            self.$.ibDnD.toggleAttribute('loading', false);
          });
          var lrThermoPath = 'state/nest/devices/thermostats/';
          lrThermoPath += 'dQ2cONq2P3MTSPzuctw3jrX_gKS0QBk1';
          lrThermoPath += '/ambient_temperature_f';
          fbRoot.child(lrThermoPath).on('value', 
            function(snapshot) {
              var val = Math.round(snapshot.val());
              val += 'F';
              self.set('state.temperature.inside', val);
              self.$.ibInside.toggleAttribute('loading', false);
            }
          );
          fbRoot.child('state/weather').on('value', function(snapshot) {
              var val = snapshot.val();
              var temp = Math.round(val.now.apparentTemperature) + '/';
              temp += Math.round(val.today.temperatureMax) + 'F';
              self.set('state.temperature.outside', temp);
              self.$.ibWeather.toggleAttribute('loading', false);
              var icon = val.now.icon.replace('-day', '');
              icon = icon.replace('-night','');
              icon = '/images/weather/' + icon + '.png';
              var weather = {
                now: {
                  summary: val.now.summary,
                  icon: icon,
                  temperature: Math.round(val.now.temperature),
                  feel: Math.round(val.now.apparentTemperature),
                },
                today: {
                  summary: val.today.summary,
                  low: Math.round(val.today.temperatureMin),
                  high: Math.round(val.today.temperatureMax),
                  precip: Math.round(val.today.precipProbability * 100) + '%',
                  humidity: Math.round(val.today.humidity * 100) + '%'
                }
              };
              self.set('weather', weather);
            }
          );
          fbRoot.child('state/nest/devices/cameras').once('value', 
            function(snapshot) {
              var cameras = snapshot.val();
              var keys = Object.keys(cameras);
              if (keys[0]) {
                var path = keys[0] + '/is_streaming';
                snapshot.child(path).ref().on('value', function(snap) {
                  var isOn = snap.val();
                  if (isOn !== self.state.nestCam) {
                    var val = 'OFF';
                    var icon = 'my-icons:video-off';
                    if (isOn === true) {
                      val = 'ON';
                      icon = 'my-icons:video-on';
                    }
                    self.set('state.nestCam', val);
                    self.set('state.nestCamIcon', icon);
                    self.$.ibNest.toggleAttribute('loading', false);
                  }                  
                });
              }
            }
          );
        },
        sortButtons: function(a, b) {
          if (a.order < b.order) {
            return -1;
          } else if (a.order > b.order) {
            return 1;
          }
          return 0;
        },
        tapButton: function(event) {
          var item = event.model.item;
          app.sendCommand(item.command);
        },
        tapMorning: function() {
          app.sendCommand({cmdName: 'ACTION_MORNING'});
        },
        tapAwake: function() {
          app.sendCommand({cmdName: 'ACTION_AWAKE'});
        },
        tapSleep: function() {
          app.sendCommand({cmdName: 'ACTION_SLEEP'});
        },
        toggleState: function() {
          var cmdName = 'STATE_HOME';
          if (this.state.state === 'HOME') {
            cmdName = 'STATE_ARMED';
          }
          app.sendCommand({cmdName: cmdName});
          this.$.ibState.toggleAttribute('loading', true);
        },
        toggleDnD: function() {
          var newState = 'ON';
          if (this.state.doNotDisturb === true) {
            newState = 'OFF';
          }
          app.sendCommand({doNotDisturb: newState});
          this.$.ibDnD.toggleAttribute('loading', true);
        },
        toggleNest: function() {
          var newState = 'ON';
          if (this.state.nestCam === 'ON') {
            newState = 'OFF';
          }
          app.sendCommand({nestCam: newState});
          this.$.ibNest.toggleAttribute('loading', true);
        },
        tapHVAC: function() {
          app.page = 'hvac';
        },
        showWeather: function() {
          this.$.weatherDialog.open();
        }
      });
    })();
  </script>
</dom-module>
