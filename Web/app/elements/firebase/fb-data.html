<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="fb-data">
  <template>
    <style include="shared-styles"></style>
    <style>
    </style>
  </template>

  <script>
    (function() {
      'use strict';
      
      Polymer({
        is: 'fb-data',
        ready: function() {
          this.harmonyActivityId = -1;
          this.hueGroups = [];
          this.hueLights = [];
          this.hueScenes = [];
          this.actionCommands = [];
          this.mediaCommands = [];
          this.mediaKeyCommands = [];
          this.etaCommands = [];
          var initialDelay = 500;
          this.async(function() {
            this.setupGroups();  
          }, initialDelay);
          this.async(function() {
            this.setupLights();  
          }, initialDelay + 150);
          this.async(function() {
            this.setupScenes();  
          }, initialDelay + 300);
          this.async(function() {
            this.setupCommands();
          }, initialDelay + 450);
        },
        setupGroups: function() {
          var self = this;
          app.fbRoot.child('state/hue/groups').on('value', function(snapshot) {
            var groups = snapshot.val();
            var newGroups = [];
            groups.forEach(function(group, index) {
              group.key = index;
              newGroups.push(group);
            });
            self.set('hueGroups', newGroups);
          });
        },
        setupLights: function() {
          var self = this;
          app.fbRoot.child('state/hue/lights').on('value', function(snapshot) {
            var lights = snapshot.val();
            var newLights = [];
            lights.forEach(function(light, index) {
              light.key = index;
              newLights.push(light);
            });
            self.set('hueLights', newLights);
          });
        },
        setupScenes: function() {
          var self = this;
          app.fbRoot.child('state/hue/scenes').on('value', function(snapshot) {
            var scenes = snapshot.val();
            var newScenes = [];
            var keys = Object.keys(scenes);
            keys.forEach(function(key) {
              var scene = scenes[key];
              var sData = scene.appdata.data;
              if (sData.indexOf('HoN') >= 0 && sData.indexOf(',UI') >= 0) {
                scene.key = key;
                newScenes.push(scene);
              }
            });
            self.set('hueScenes', newScenes);
          });
        },
        setupCommands: function() {
          var self = this;
          app.fbRoot.child('config/HomeOnNode/commands').on('value', 
            function(snapshot) {
              var commands = snapshot.val();
              var keys = Object.keys(commands);
              var newActions = [];
              var newMedia = [];
              var newMediaKey = [];
              var newETAs = [];
              keys.forEach(function(key) {
                var command = commands[key];
                if (command.label) {
                  command.key = key;
                  if (command.kind === 'action') {
                    newActions.push(command);
                  } else if (command.kind === 'media') {
                    newMedia.push(command);
                  } else if (command.kind === 'mediaKey') {
                    newMediaKey.push(command);
                  } else if (command.kind === 'eta') {
                    newETAs.push(command);
                  }
                }
              });
              self.set('actionCommands', newActions);
              self.set('mediaCommands', newMedia);
              self.set('mediaKeyCommands', newMediaKey);
              self.set('etaCommands', newETAs);
            }
          );
        },
        properties: {
          hueScenes: {
            type: Array,
            notify: true
          },
          hueGroups: {
            type: Array,
            notify: true
          },
          hueLights: {
            type: Array,
            notify: true
          },
          actionCommands: {
            type: Array,
            notify: true
          },
          etaCommands: {
            type: Array,
            notify: true
          },
          mediaCommands: {
            type: Array,
            notify: true
          },
          mediaKeyCommands: {
            type: Array,
            notify: true
          }
        }
      });
    })();
  </script>
</dom-module>
