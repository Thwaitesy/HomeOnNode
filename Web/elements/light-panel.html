<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/bower_components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/core-menu/core-menu.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/core-icons/av-icons.html">

<polymer-element name="light-panel">

  <template>
    <link no-shim href="/styles/pbutton.css" rel="stylesheet">
    <style type="text/css">
      paper-dropdown-menu {
        margin-top: 0;
      }
    </style>
    <div layout start-justified wrap horizontal center>
      <paper-dropdown-menu flex>
        <paper-dropdown class="dropdown">
          <core-menu id="coreMenu" selected="TOGGLE" class="menu" valueattr="modifier" flex on-core-select="{{setModifier}}">
            <paper-item modifier="TOGGLE">
              Toggle
            </paper-item>
            <paper-item modifier="ON">
              On
            </paper-item>
            <paper-item modifier="OFF">
              Off
            </paper-item>
            <template repeat="{{modifier in modifiers}}">
              <paper-item modifier="{{modifier.command}}">
                {{modifier.label}}
              </paper-item>
            </template>
          </core-menu>
        </paper-dropdown>
      </paper-dropdown-menu>
    </div>
    <div layout start-justified wrap horizontal>
      <template repeat="{{devices as device}}">
        <paper-button colored?="{{device.isOn==true}}" on-tap="{{tapButton}}" device="{{device}}" flex>
          {{device.label}}
        </paper-button>
      </template>
    </div>
  </template>
  <script type="text/javascript">
    /* jshint browser: true */
    /* global fb */
    'use strict';

    Polymer({
      created: function() {
        this.modified = undefined;
        this.devices = [];
        this.modifiers = [];
        this.lights = [];
        this.lightsOn = [];
        this.lightsOff = [];
        var self = this;
        fb.child('config/HomeOnNode/lightScenes').on('value', function(snapshot) {
          var newModifiers = [];
          snapshot.forEach(function(snap) {
            var cmd = {
              label: snap.key(),
              command: snap.key()
            };
            newModifiers.push(cmd);
          });
          self.modifiers = newModifiers;
        });
        fb.child('config/HomeOnNode/commands').on('value', function(snapshot) {
          self.devices = window.getCommands(snapshot.val(), 'lights');
        });
        fb.child('state/hue/lights').on('value', function(snapshot) {
          self.lightStateChanged(snapshot.val());
        });
      },
      lightStateChanged: function(newVal) {
        var newOn = [];
        var newOff = [];
        for (var i = 1; i < newVal.length; i++) {
          var light = newVal[i];
          if (light.state.on === true) {
            newOn.push(i);
          } else {
            newOff.push(i);
          }
        }
        this.lightsOn = newOn;
        this.lightsOff = newOff;
        this.updateLightStatus();
      },
      updateLightStatus: function() {
        for (var i = 0; i < this.devices.length; i++) {
          var device = this.devices[i];
          if (device.hue) {
            var isOn = true;
            var hueSets = device.hue;
            for (var j = 0; j < hueSets.length; j++) {
              var hueSet = hueSets[j];
              var lightsInSet = hueSet.lights;
              for (var k = 0; k < lightsInSet.length; k++) {
                if (this.lightsOn.indexOf(lightsInSet[k]) === -1) {
                  isOn = false;
                  break;
                }
              }
              if (isOn === false) {
                break;
              }
            }
            device.isOn = isOn;
          }
        }
      },
      ready: function() {
      },
      setModifier: function(event, details, sender) {
        if (details.isSelected === true) {
          window.lastEvent = Date.now();
          this.modifier = this.$.coreMenu.selected;
          console.log('setModifier', this.modifier);
        }
      },
      tapButton: function(event, details, sender) {
        var device = sender.templateInstance.model.device;
        var cmd = {
          'command': device.command
        };
        if (this.modifier === 'TOGGLE') {
          if (device.isOn === true) {
            device.isOn = false;
            cmd.modifier = 'OFF';
          } else {
            device.isOn = true;
            cmd.modifier = null;
          }
        } else if (this.modifier === 'OFF') {
          cmd.modifier = 'OFF';
          device.isOn = false;
        } else if (this.modifier === 'ON') {
          cmd.modifier = 'ON';
          device.isOn = true;
        } else {
          device.isOn = true;
          cmd.modifier = this.modifier;
        }

        window.lastEvent = Date.now();
        console.log('tapButton', cmd);
        fb.child('commands').push(cmd);
      }
    });
  </script>
</polymer-element>
