<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog/paper-action-dialog.html">
<link rel="import" href="../bower_components/core-icons/core-icons.html">
<link rel="import" href="../bower_components/core-icons/image-icons.html">

<polymer-element name="device-panel">
  <template>

    <style type="text/css">
      .box {
        display: inline-block;
        margin: 8px;
        padding: 8px;
        min-width: 320px;
        max-width: 500px;
        background-color: white;
        border: 1px solid #e0e0e0;
      }
      .container {
        margin: 8px;
      }
      .offline {
        color: #B71C1C;
      }
      .online {
        color: #1B5E20;
      }
      .secondary {
        color: #727272;
      }
      .text-right {
        text-align: right;
      }
      .box > div {
        margin-bottom: 8px;
      }
    </style>
    <div class="container" layout start-justified wrap horizontal center>
      <template repeat="{{d in devices}}">
        <div class="box" flex>
          <div horizontal layout>
            <div flex><b>{{d.key}}</b></div>
            <div>
              <core-icon icon="image:brightness-1" class="{{d.online === true ? 'online' : 'offline'}}"></core-icon>
            </div>
          </div>
          <div horizontal layout>
            <div flex>Last Updated</div>
            <div flex two class="text-right {{isOld(d.heartbeat) === true ? 'offline' : ''}}">
              {{d.heartbeat | toDateTime}}
            </div>
          </div>
          <template if="{{d.started_at}}">
            <div horizontal layout>
              <div flex>Started</div>
              <div flex two class="text-right">{{d.started_at | toDateTime}}</div>
            </div>
          </template>
          <template if="{{d.shutdown_at}}">
            <div horizontal layout>
              <div flex>Shutdown</div>
              <div flex two class="text-right">{{d.shutdown_at | toDateTime}}</div>
            </div>
          </template>
          <div horizontal layout>
            <div flex>Version</div>
            <div flex two class="text-right">{{d.version}}</div>
          </div>
          <div horizontal layout>
            <div flex>Log to Firebase</div>
            <div flex class="text-right">
              <paper-toggle-button on-change="{{toggleFBLog}}" checked?="{{p.logToFirebase === true}}"></paper-toggle-button>
            </div>
          </div>
          <div horizontal layout>
            <div flex>Debug Log</div>
            <div flex class="text-right">
              <paper-toggle-button on-change="{{toggleDBLog}}" checked?="{{p.debugLog === true}}"></paper-toggle-button>
            </div>
          </div>
          <div horizontal center-justified layout>
            <paper-button on-tap="{{tapRestart}}">Restart</paper-button>
            <paper-button on-tap="{{tapShutdown}}">Shutdown</paper-button>
          </div>
        </div>
      </template>
    </div>
    <paper-action-dialog on-core-overlay-close-completed="{{dialogClosed}}" on-core-overlay-open-completed="{{dialogOpened}}" id="dialog" backdrop heading="Are you sure?">
      <style type="text/css">
        paper-button[autofocus] {
          color: #03a9f4;
        }
      </style>
      <p>Are you sure you wish to {{action}} {{deviceToAction.key}}?</p>
      <paper-button dismissive autofocus>Cancel</paper-button>
      <paper-button on-tap="{{tapConfirm}}" affirmative>{{action}}</paper-button>
    </paper-action-dialog>
  </template>
  <script type="text/javascript">
    Polymer({
      created: function() {
        this.devices = [];
        this.action = null;
        this.deviceToAction = null;
        var self = this;
        fb.child("devices").on("value", function(snapshot) {
          self.devices = [];
          snapshot.forEach(function(itemObj) {
            var item = itemObj.val();
            item.key = itemObj.key();
            self.devices.push(item);
          });
        });
      },
      toggleFBLog: function(event, details, sender) {
        var model = sender.templateInstance.model.d;
        var path = "devices/" + model.key + "/logToFirebase";
        fb.child(path).set(sender.checked);
        window.lastEvent = Date.now();
      },
      toggleDBLog: function(event, details, sender) {
        var model = sender.templateInstance.model.d;
        var path = "devices/" + model.key + "/debugLog";
        fb.child(path).set(sender.checked);
        window.lastEvent = Date.now();
      },
      tapRestart: function(event, details, sender) {
        var model = sender.templateInstance.model.d;
        this.deviceToAction = model;
        this.action = "restart";
        this.$.dialog.open();
        window.lastEvent = Date.now();
      },
      tapShutdown: function(event, details, sender) {
        var model = sender.templateInstance.model.d;
        this.deviceToAction = model;
        this.action = "shutdown";
        this.$.dialog.open();
        window.lastEvent = Date.now();
      },
      tapConfirm: function(event, details, sender) {
        var path = "devices/" + this.deviceToAction.key + "/"+ this.action;
        fb.child(path).set(true);
        window.lastEvent = Date.now();
      },
      dialogOpened: function(event, details, sender) {
        setTimeout(function() {
          if (sender.opened === true) {
            sender.close();
          }
        }, 30000);
        window.lastEvent = Date.now();
      },
      dialogClosed: function(event, details, sender) {
        this.deviceToAction = null;
        this.action = null;
        window.lastEvent = Date.now();
      },
      toDateTime: function(value) {
        if (value) {
          return moment(value).format("M/D/YY, h:mm:ss a");
        } else {
          return "";
        }
      },
      isOld: function(value) {
        if (value) {
          var diff = (moment() - moment(value)) / 1000;
          if (diff > 120) {
            return true;
          }
        }
        return false;
      }
    });
  </script>
</polymer-element>
