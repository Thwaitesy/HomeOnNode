<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">

<polymer-element name="ac-panel" attributes="devices">
  <template>
    <link rel="stylesheet" type="text/css" href="/styles/main.css">
    <style type="text/css">
      .acTemp {
        min-width: 1.1em;
        text-align: center;
      }
      .mode {
        min-width: 4em;
      }
      .acTemp[disabled] {
        color: #c9c9c9;
        opacity: 0;
      }
      paper-toggle-button::shadow [checked] .toggle {
        background-color: #03A9F4;
      }
      paper-toggle-button::shadow [checked] .toggle-ink {
        color: #81D4FA;
      }
      paper-icon-button.lm {
        margin-left: 20px;
        margin-right: 12px;
      }
      paper-icon-button.rm {
        margin-left: 12px;
        margin-right: 0px;
      }
      li {
        min-height: 40px;
        margin-bottom: 1vw;
      }
      ul {
        padding-left: 0;
        margin-top: 0;
        list-style-type: none;
      }
    </style>
    <ul vertical layout class="text-large">
      <template repeat="{{devices as device}}">
        <li horizontal layout center>
          <span flex>
            {{device.name}} 
            ({{device.ambient_temperature_f}}&deg;F)
          </span>
          <paper-dropdown-menu class="mode">
            <paper-dropdown class="dropdown">
              <core-menu id="coreMenu" selected="{{device.hvac_mode}}" class="menu" valueattr="modifier" flex on-core-select="{{stateChanged}}">
                <paper-item modifier="heat-cool">Auto</paper-item>
                <paper-item modifier="cool">Cool</paper-item>
                <paper-item modifier="heat">Heat</paper-item>
                <paper-item modifier="off">Off</paper-item>
              </core-menu>
            </paper-dropdown>
          </paper-dropdown-menu>
          <paper-icon-button class="lm" on-tap="{{tempDown}}" disabled?="{{device.hvac_mode == 'off'}}" icon="expand-more"></paper-icon-button>
          <div class="acTemp" disabled?="{{device.hvac_mode == 'off'}}">{{device.target_temperature_f}}</div>
          <paper-icon-button class="rm" on-tap="{{tempUp}}" disabled?="{{device.hvac_mode == 'off'}}" icon="expand-less"></paper-icon-button>
        </li>
      </template>
    </ul>
  </template>
  <script type="text/javascript">
    /* jshint browser: true */
    /* global fb */
    'use strict';

    Polymer({
      created: function() {
        this.devices = [];
        var self = this;
        fb.child('state/nest/devices/thermostats').on('value', function(snapshot) {
          var val = snapshot.val();
          if (val) {
            var devices = [];
            var keys = Object.keys(val);
            for (var i = 0; i < keys.length; i++) {
              var k = keys[i];
              var thermostat = val[k];
              thermostat.key = k;
              devices.push(thermostat);
            }
            self.devices = devices;
            console.log('Nest HVAC', devices);
          }
        });
        // var f1 = {name: 'LR', hvac_mode: 'off', target_temperature_f: 72, ambient_temperature_f: 68};
        // self.devices.push(f1);
        // var f2 = {name: 'BR', hvac_mode: 'heat-cool', target_temperature_f: 72, ambient_temperature_f: 70};
        // self.devices.push(f2);
      },
      tempDown: function(event, details, sender) {
        var thermostat = sender.templateInstance.model.device;
        thermostat.target_temperature_f -= 1;
        var cmd = {
          thermostatId: thermostat.key,
          targetTemperature: thermostat.target_temperature_f
        };
        fb.child('commands').push(cmd);
        console.log('tempDown', cmd);
        window.lastEvent = Date.now();
      },
      tempUp: function(event, details, sender) {
        var thermostat = sender.templateInstance.model.device;
        thermostat.target_temperature_f += 1;
        var cmd = {
          thermostatId: thermostat.key,
          targetTemperature: thermostat.target_temperature_f
        };
        fb.child('commands').push(cmd);
        console.log('tempUp', cmd);
        window.lastEvent = Date.now();
      },
      stateChanged: function(event, details, sender) {
        if (details.isSelected === true) {
          var thermostat = sender.templateInstance.model.device;
          var cmd = {
            thermostatId: thermostat.key,
            mode: thermostat.hvac_state
          };
          fb.child('commands').push(cmd);
          console.log('stateChanged', cmd);
          window.lastEvent = Date.now();
        }
      }

    });
  </script>
</polymer-element>
