<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/core-icons/core-icons.html">

<polymer-element name="error-list" attributes="deviceFilter typeFilter">

  <template>
    <link rel="stylesheet" type="text/css" href="/styles/main.css">
    <style type="text/css">
      ul {
        padding-left: 0;
        list-style-type: none;
        margin-top: 0;
      }
      li {
        border-bottom: 1px solid #b6b6b6;
        min-height: 48px;
        padding: 0 16px;
        vertical-align: middle;
      }
      .circle {
        width: 16px;
        height: 16px;
        background-color: red;
        display: inline-block;
        border-radius: 50%;
      }
      .red {
        color: #B71C1C;
      }
      .yellow {
        color: #FFC107;
      }
      li {
        font-size: 0.8em;
      }
      a {
        text-decoration: none;
      }
    </style>

    <ul vertical layout class="text-medium">
      <template repeat="{{item in items}}">
        <template if="{{item.device===deviceFilter || deviceFilter==='*'}}">
          <template if="{{item.msgType===typeFilter || typeFilter==='*'}}">
            <li horizontal layout center >
              <span flex>
                <template if="{{item.msgType==='exception'}}">
                  <a href="https://boiling-torch-4633.firebaseio.com/logs/errors/{{item.key}}" target="_blank">
                    <core-icon class="red" icon="error"></core-icon>
                  </a>
                </template>
                <template if="{{item.msgType==='error'}}">
                  <a href="https://boiling-torch-4633.firebaseio.com/logs/errors/{{item.key}}" target="_blank">
                    <core-icon class="yellow" icon="warning"></core-icon>
                  </a>
                </template>
                <template if="{{item.msgType==='shutdown'}}">
                  <a href="https://boiling-torch-4633.firebaseio.com/logs/errors/{{item.key}}" target="_blank">
                    <core-icon class="yellow" icon="exit-to-app"></core-icon>
                  </a>
                </template>
                {{item.date | toDateTime }}
              </span>
              <!-- <span flex>{{item.device}}</span> -->
              <span flex three>{{item.message | trimMessage }}</span>
            </li>
          </template>
        </template>
      </template>
    </ul>
  </template>
  <script type="text/javascript">
    /* jshint browser: true */
    /* global fb */
    'use strict';

    Polymer({
      created: function() {
        this.items = [];
      },
      ready: function() {
        var self = this;
        fb.child("logs/errors").limitToLast(50).on("child_added", function(snapshot) {
          var item = snapshot.val();
          item.key = snapshot.key();
          self.items.unshift(item);
        });
      },
      toDateTime: function(value) {
        if (value) {
          return moment(value).format("M/D/YY, h:mm:ss a");
        } else {
          return "";
        }
      },
      trimMessage: function(value) {
        if ((value) && (value.length > 256)) {
          return value.substring(0, 255) + "...";
        }
        return value;
      },
      onTap: function(event, details, sender) {
        var item = sender.templateInstance.model.item;
        console.log("TAP", item.key, item);
      }
    });
  </script>
</polymer-element>
